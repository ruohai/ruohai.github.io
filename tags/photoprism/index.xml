<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>PhotoPrism on 喵ฅ^•ﻌ•^ฅ</title>
    <link>https://ruohai.wang/tags/photoprism/</link>
    <description>Recent content in PhotoPrism on 喵ฅ^•ﻌ•^ฅ</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Tue, 21 Nov 2023 08:49:04 +0800</lastBuildDate><atom:link href="https://ruohai.wang/tags/photoprism/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>在玩客云上部署PhotoPrism</title>
      <link>https://ruohai.wang/202311/photoprism-install-on-onecloud/</link>
      <pubDate>Tue, 21 Nov 2023 08:49:04 +0800</pubDate>
      
      <guid>https://ruohai.wang/202311/photoprism-install-on-onecloud/</guid>
      <description>前言 硬件性能：
photoprism官方明确要求部署pp服务的最低硬件要求是4核 + 4GB内存，玩客云的cpu性能孱弱而且内存也仅仅只有1GB 能跑起来的前提是禁用很多图像算法识别功能 如果你需要的是一个全功能的photoprism，那这个方案不适合你，更不适合玩客云 实测部署成功以后，photoprism能跑，网页端访问流畅，导入20张图片未出现oom。适合轻负载使用 存储空间：
docker.io + docker-compose大概占用300MB存储 photoprism + mariadb镜像大概占用1.6GB存储 合计大概占用2GB空间，玩客云内置emmc可用空间大概是6GB，能装下，但需要提前考虑存储空间的占用 部署 &amp;amp; 优化 第一步：安装docker环境
这一步没啥好说的，两条命令。
apt install docker.io apt install dockere-compose 我倾向于使用debian软件仓库里的docker，所以apt一把梭。
因为docker hub被封，记得配置docker国内镜像
nano /etc/docker/daemon.json 录入以下内容：
{ &amp;#34;registry-mirrors&amp;#34;: [ &amp;#34;https://registry.hub.docker.com&amp;#34;, &amp;#34;http://hub-mirror.c.163.com&amp;#34;, &amp;#34;https://mirror.baidubce.com&amp;#34;, &amp;#34;https://docker.mirrors.sjtug.sjtu.edu.cn&amp;#34;, &amp;#34;https://docker.nju.edu.cn&amp;#34; ], &amp;#34;iptables&amp;#34;: false } 保存后退出，然后重启docker。
systemctl restart docker.service 其中的&amp;quot;iptables&amp;quot;: false是禁止docker调整iptables，因为我用的ufw管理防火墙。请根据自己的情况保留或者删除这条。
第二步：配置文件调整
先创建目录吧。玩客云内置存储空间比较珍贵，pp的运行目录记得放在外置存储。
# 创建目录，记得把pp运行目录指向外置硬盘 mkdir photoprism # 进目录 cd photoprism # 下载官方的配置文件 wget https://dl.photoprism.app/docker/armv7/docker-compose.yml 官方提供的配置文件，除了常规的密码、运行目录之类，还有以下几个项目要修改
PHOTOPRISM_DISABLE_CHOWN: &amp;quot;true&amp;quot;，这个选项是pp每次启动的时候调整storage目录的权限，如果图库文件数量很大，会导致每次pp启动都非常非常耗时，建议禁用 PHOTOPRISM_DISABLE_WEBDAV: &amp;quot;true&amp;quot;，禁用webdav服务。webdav服务用来分享照片的，用不上，禁用。也可以在webui里禁用。 PHOTOPRISM_DISABLE_TENSORFLOW: &amp;quot;true&amp;quot;，禁用tensorflow。图像算法识别功能，吃硬件性能，玩客云上跑pp必须禁用掉。务必在配置文件中直接禁用，要不然启动pp都很难。 user: &amp;quot;1000:1000&amp;quot;，有权限洁癖的用户需要这个，自己加一行参数，指定photoprism以non-root用户运行。如果加了这条，对应的originals、import、storage三个目录需要提前手动创建并分配用户权限。如果以root用户运行，这条可以无视。 image: linuxserver/mariadb:10.</description>
    </item>
    
    <item>
      <title>PhotoPrism视频功能的不足</title>
      <link>https://ruohai.wang/202310/photoprism-use-guide-about-video/</link>
      <pubDate>Sun, 22 Oct 2023 02:03:14 +0800</pubDate>
      
      <guid>https://ruohai.wang/202310/photoprism-use-guide-about-video/</guid>
      <description>前言 photoprism以下简写pp。
文中pp使用docker-compose方式部署。
两个星期pp的使用体验下来，对比起immich，就像是守旧老派对标先锋新锐的感觉。使用的时间越久，这种体验越强烈。
当然这篇文章重点讲pp对于视频文件的使用体验。
pp对于视频文件的支持这一块值得单独拎出来写一篇文章，因为能看出来pp在这么多年的迭代过程中，对于视频功能似乎一直不怎么上心，导致视频文件的交互体验非常差。也许是因为对产品的定位，也许是觉得视频太吃硬件性能、太消耗存储空间
视频功能的不足 默认不开启视频转码。 在默认情况下，pp是不开启视频转码的。这种情况下，查看视频就是直接播放原素材。如果原视频的拍摄规格比较高的话，非常考验硬盘读写速度、网络带宽和播放设备的解码能力。
开启视频转码需要改配置文件 immich的视频转码功能直接在网页端就可以配置，分辨率、码率、硬件加速，网页端都提供了配置入口。pp的设置页面虽然有一大堆设置项，但那些都是针对照片的，包括让我误解了很久的【动态预览】，我一直以为这个是指实时转码，其实它也是针对照片。
pp开启视频转码，需要编辑docker-compose.yml文件，解开注释以下代码。
PHOTOPRISM_FFMPEG_ENCODER: &amp;#34;software&amp;#34; ## 解码方式，默认软解 PHOTOPRISM_FFMPEG_SIZE: &amp;#34;1920&amp;#34; ## 转码分辨率，默认1080p PHOTOPRISM_FFMPEG_BITRATE: &amp;#34;32&amp;#34; ## 转码码率，默认32Mbps 然后重新部署pp即可。
docker-compose up -d 如果想配置集显或者显卡硬解，请参考官网，还需要改更多地方。
开启视频转码后不会提前转码 启用了视频转码以后，并不会把图库里的所有视频全部都转码一遍，不会。
pp的视频转码，是用户在点击视频播放的那一刻，才立刻开始转码，等转码好了，再给你播放转码处理过的【小】视频。这中间会有一个等待时间，至于这个等待时间有多长，取决于你用来跑pp的电脑性能有多差，可能等5秒，也可能等50秒，如果视频很大规格很高的话，等5分钟也不是没可能。至于看个视频需要等这么久才开始播放，这使用体验有多糟糕，pp官方不在乎。
那有没有办法把图库里的视频全部都转码一遍呢，有，有办法。官网给了一条命令，执行以后，会把图库里的全部视频都提前转码，下次点击播放视频就不需要再等了。
docker-compose exec photoprism photoprism convert 如果图库又上传了新的视频，我估计，应该还需要再手动执行这条命令。
视频播放界面很简陋 播放视频的时候，是一个全屏遮罩的播放界面，不仅和查看照片一样没有信息侧栏，连编辑的入口都没有。而且播放界面点出菜单选择下载，下载下来的竟然是转码后的【小】视频，下载的竟然不是原视频！
那想要查看视频文件的exif信息要怎么操作？想要下载原视频要怎么操作？在照片墙页面，点击小圈圈选中文件，然后点击页面右小角的大圆圈，弹出功能菜单，里面有一个圈是【编辑】功能可以查看exif，一个圈是【下载】可以下载原视频。
视频不支持鼠标悬停自动播放 这个功能immich是支持的，非常方便查看视频内容。而且转码以后的小视频，全屏播放的时候清晰度会比较差，十分影响观看体验，在照片墙界面小窗口播放是最合适的。很不幸，pp不支持这个功能，视频文件默认只抽取一张图片当封面，想查看视频内容，得点击播放，然后弹出那个简陋的全屏播放遮罩。如果这个视频文件没有转码的话，你可能还需要耐心的等上几十秒甚至几分钟才能看。
视频播放不支持旋转 网页端播放视频时，没有旋转方向的功能，不管视频是竖的还是横的，将就着看吧。不过，如果在手机上用pwa小应用（网页）看视频的话，它会无视手机是否关闭了自动转向，根据重力感应计自动旋转，倒是实现了视频旋转方向的功能。</description>
    </item>
    
    <item>
      <title>PhotoPrism的优点和缺点</title>
      <link>https://ruohai.wang/202310/photoprism-pros-and-cons/</link>
      <pubDate>Sat, 14 Oct 2023 04:45:30 +0800</pubDate>
      
      <guid>https://ruohai.wang/202310/photoprism-pros-and-cons/</guid>
      <description>前言 优缺点内容会随着日常使用不断更新。
下文中photoprism会简写成pp。
这篇文章中列举的优缺点不涉及界面是否好看之类，喜欢什么ui/ux直接看官网demo即可。
对比产品是immich。
其它类似产品lychee、piwigo、mt-photos、photoview、librephotos等等，懒得试了。
简单总结：稳定好用，缺点很多但还算能接受。建议photoprism作为主相册，immich作为备用相册，俩一起用。
优点 稳定。优点等级：✔️✔️✔️✔️✔️ 服务稳定运行，这点是日常感知非常不明显，但却是最重要的优点。pp的个人自建版本免费，另外还有多种不同定价的收费服务方案。能出收费商业方案的，相信我，不会有太大的bug。而且我在日常使用的过程中，确实感觉就是pp运行起来【稳如老狗】，不管出现什么错误操作，它都有对应的撤回/修正的方案。
而我在使用immich的短短一个星期里碰到了好几个bug，对比以后，pp的这个优点值五星。
当你碰到服务出了bug，自己debug也毫无头绪，最后只能推倒从来，把80000张照片倒过来倒过去的时候，就会发现这个点的重要性。
支持多硬盘。优点等级：✔️✔️✔️✔️✔️ pp服务跑起来以后，常用的会有三个目录：
originals：存放归档的原图 storage：存放缓存、缩略图、转码视频、配置文件 import：存放需要导入到pp的照片和视频 这三个目录都支持自定义路径。比如originals目录指向大容量的机械硬盘来保存原图，方便维护的同时也保障数据安全。比如storage目录指向高速ssd，用来加速浏览性能，避免网页浏览的时候卡顿。比如import目录可以指向存了大量图片的老图库的硬盘，然后在网页端直接一键导入完成数据迁移。pp甚至还支持给照片和视频分别指定路径，可以把照片和视频分开存到两个硬盘。
支持多硬盘还有一个好处，就是存储空间存储空间的最大化利用，这点对比immich只能指定一个目录的时候非常明显。
immich只能指定一个目录，意味着只支持单盘，所以所有数据，无论原图还是缓存、缩略图、转码视频等等，都只能保存在一个硬盘上。一个是不方便维护，二是这导致硬盘空间消耗的特别快。比如2TB的硬盘，原图占了1.5TB，那缓存+缩略图+转码视频可能得占掉500GB，那这时候就不得不考虑买一个更大容量的硬盘，然后迁移数据。而pp因为支持多盘，缓存盘不会去占用原图盘的空间，硬盘空间会更耐用一些。
支持多语言。优点等级：✔️ immich不支持多语言（没有中文），pp支持多语言，这就是pp的一个优点。
归档照片统一重命名。优点等级：✔️✔️ 默认设置下，所有照片视频归档以后都会被按照固定格式统一重命名，yyyymmdd-hhMMss + 8位随机字符串 + 文件后缀名。原文件名只会保存在数据库。
这点孰优孰劣看个人喜好，我觉得是个优点。因为原始文件的文件名杂乱无章，统一以后看上去整理利落，就算是一个处女座的强迫症用户都挑不出一点瑕疵。而且yyyymmdd-hhMMss的前缀也很容易辨认。
pp网页端支持通过原文件名搜索。
如果不喜欢这点的用户记得从设置里关掉这个功能。
批量导入很方便。优点等级：✔️✔️✔️✔️ pp有一个专门的import目录是导入用的，配合samba把这个目录设置成smb共享文件夹，直接映射到日常使用的windows电脑或者mac电脑上，只需要把照片视频复制到import文件夹，然后在pp网页点击导入就行了，非常方便。这比起immich需要装npm再用命令来批量导入可方便太多了。
也可以把老的图库直接复制移动到originals目录下，然后在网页端点击索引。这样可以保留老图库的目录结构和文件名。
缺点 导入照片耗时漫长。缺点等级：❌❌❌❌❌ 如果是通过import目录批量导入图库，那这个导入过程和跑pp的主机cpu性能直接关联。导入照片 + 算法处理照片 + 照片归档，整个流程是同步线性进行的，也即是上传一张照片 + 算法处理照片 + 照片归档，这个流程跑完了，再开始处理下一张照片。
这意味着什么，如果用来跑pp的电脑性能很差（很多人都会拿性能很差的旧电脑用来跑nas然后装很多服务），那算法处理照片这一步会卡很久，因为这一步包含了照片元数据读取、人脸识别、照片主体识别、给照片加上各种标签、gps信息处理等等一长串的任务。如果电脑的cpu性能孱弱，那一张照片就要处理4~5秒钟，如果照片的内容包含了大量的元素，甚至可能要处理10秒钟。这就会导致【导入照片】这个过程变得非常非常非常的漫长，可以算一下如果要导入10000张照片，每张照片耗时5秒钟，cpu是两核两线程的古董，整个过程需要耗时多久，是7个小时！天哪，是7个小时！！！！如果照片数量翻翻，50000张照片，完成导入又需要多久。
这个缺点在2023年简直是难以置信，千万不要用弱鸡cpu来跑pp。
正确的处理方式可以参考immich，导入 + 读取元数据 + 归档 + 图像算法处理，这些任务全部异步处理。限制导入速度的只有你的网络带宽和硬盘读写速度。无论是100张还是1000000张，导入时直接跑满硬盘读写速度，体验就是丝般顺滑。至于读取元数据、生成缩略图、图像算法处理、视频转码，扔到后台去慢慢处理。
查看大图界面没有exif侧栏。缺点等级：❌❌❌ 大抵现在所有的照片查看软件都支持侧栏显示exif信息，高级一点的甚至还能在侧栏显示gps地图定位信息，比如immich。但很不幸pp不支持，它没有侧栏。
想要在pp里看到exif信息，有两个方法，第一种就是照片墙界面选择卡片布局或者列表布局，会展示一些简略的exif信息，第二种就是在查看大图界面，点击一下【编辑】就会进入照片信息编辑界面，会出现5个标签可以查看照片的各种信息，但很不幸依然没有gps地图定位。
没有官方app。缺点等级：❌❌❌❌ 官方只提供了网页端服务，pc端、移动端都只能用浏览器访问pp网页。但好消息是pp网页支持pwa，也就是可以把网页“安装”到桌面当成一个app用，使用体验嘛就那样。
官方推荐的第三方app收费。缺点等级：❌❌❌❌❌ 这点非常下头，非常的下头。官方没app也认了，但官方贴心的给你推荐了一个app，叫photosync，ios/android平台都有，可以实现移动端同步照片到pp。不过天下没有免费的午餐，这app下载免费，但有内置广告，同步照片的功能很不幸需要付费，你可以免费体验7天然后选择花$5.99购买。
视频不支持鼠标悬停自动播放。缺点等级：❌ immich支持照片墙浏览时鼠标悬停视频自动播放，pp不支持。在使用体验上影响不大，就是每次看视频需要多点击一下。
不支持照片旋转。缺点等级：❌❌❌ 很多照片拍摄的时候有的横向有的竖向，我也不要求pp用算法自动纠正，但至少给我一个编辑的入口吧。很不幸，没有旋转照片的功能。
归档目录结构无法自定义。缺点等级：❌❌❌ pp的归档目录结构是yyyy/mm两级，也就是归档的最小时间单位是月，举例就是2023年10月拍的所有照片和视频，无论是10月哪一天拍的，都会归档到2023/10这个目录下。这个目录结构无法自定义，比如我想改成2023/2023-10/2023-10-14，很不幸，不支持自定义。
归档照片统一重命名。缺点等级：❌❌❌❌❌ 默认设置下，pp对归档的文件会统一重命名，格式是yyyymmdd-hhMMss的前缀+8位随机字符串+文件名后缀，原文件名会存在数据库里。这点对很多人来说是一个致命的缺点，这意味着源文件名的丢失。虽然源文件名存在数据库，pp网页也支持原文件名的搜索，但这导致如果数据库崩了，或者迁移服务、重新部署的时候没备份数据库，那原文件名就永远的丢失了。所以在意这点的用户，务必、千万一定要在开始导入照片之前，在设置里关掉这个功能。
对视频的支持不理想。缺点等级：❌❌❌❌ 提这个点我需要提前交代下我的硬件和软件配置：</description>
    </item>
    
    <item>
      <title>PhotoPrism的安装以及和Immich的优缺点对比</title>
      <link>https://ruohai.wang/202310/photoprism-install-guide/</link>
      <pubDate>Thu, 12 Oct 2023 18:48:49 +0800</pubDate>
      
      <guid>https://ruohai.wang/202310/photoprism-install-guide/</guid>
      <description>前言 10月初因为google one订阅计划到期没续，导致google one存储空间耗尽，接着连锁反应导致我的gmail因为没有空间而无法使用，所以终于下定决心：
要自建相册服务，不能在关键时候被google卡脖子！
（开玩笑的
immich的优缺点 上周弄了个机器部署immich，实际使用一段时间后，几个最突出的优点：
全终端覆盖，除了web服务之外，官方就提供了ios和android的app web和app的ui/ux都模仿的google photos，所以上手使用没难度 但是，但是啊，immich用起来确实各方面都还可以，但也有不少槽点，列举一二：
immich只能指定一个目录，也就是上传目录、缩略图目录、原图目录、转码视频目录，统统都一个目录下（aka一个硬盘）。导致会有原始媒体文件体积的20%左右的空间，是被缩略图、缓存之类消耗掉的，这导致硬盘空间更容易耗尽，意味着会需要更频繁的更换大容量硬盘和迁移/恢复。
上传了7万多张照片+视频以后，web端浏览非常、非常的卡，首页时间线的瀑布流展示出来需要等5~10秒钟左右。
上传照片的流程：新照片被重命名并放到upload目录 → immich读取新照片的exif → immich把新照片归档到指定根目录并还原文件名。这个流程如果顺利的话就很完美，没有问题。但我在短短几天的时候过程中，出现了好几次上传的照片被积压在upload目录，无论怎么在管理员的Job管理页面重启读取照片metadata的任务，积压在upload目录的文件都毫无变化，无法正确归档。最后的解决方案，第一次碰到这问题时，我简单排查以后感觉是immich-microserver出了问题，也不知道咋bugfix，索性备份了400G的内容以后重新部署。第二次在重新部署的immich服务上又碰到了这个问题，还好这次积压的不多只有17个文件，我下载到本地，根据日期核对图库以后，确认原图已经存在于图库，所以直接清空了upload目录。
物色其它方案 因为使用中种种的槽点，尤其是照片积压在upload目录这个严重的bug，所以我又开始物色其它自建相册方案：lychee、piwigo、photoprism、etc&amp;hellip;
古人有云：少年不知愁滋味，乱花渐欲迷人眼。看着这么多的方案，一时不知道该先试哪个。
看了一圈官方文档以后，挑中了photoprism。
优点如下：
自定义图库目录、缩略图目录、原图目录、转码视频目录，可以分别指定路径。这就可以实现原图放一个硬盘（方便维护），缩略图和缓存放ssd（加速图片浏览）。这简直就是对着immich的弱点痛打啊。 多语言支持，自带中文。虽然相册服务那点简单的英文对我来说没有使用障碍，但有中文可选总是加分的。 web端使用起来体验比immich响应速度快，可配置的内容更多更细致。 看完photoprism的文档以后，十分心动，立刻就弄个虚拟机，开始部署。
部署photoprism 我的机器用的系统时debian 12 bookworm stable，使用官网推荐的docker compose方案进行部署。
使用的photoprism版本是Build 231011-63f708417，docker-compose.yml文件中指定的version是3.5。注意不同的版本可能部署方式会有出入，最终以官网的文档为准。
官网文档：https://docs.photoprism.app/getting-started/docker-compose/
第一步：安装docker和docker-compose。
apt install docker apt install docker-compose 第二步：下载docker-compose.yml文件。
mkdir ~/.photoprism cd ~/.photoprism wget https://dl.photoprism.app/docker/docker-compose.yml 第三步：配置参数。
注意： 自建相册服务一般很少会反复折腾，都是部署好了以后就是24H运行除非硬盘满了。所以下面的10个参数一定要好好理解后进行配置，避免返工。
下载好docker-compose.yml以后，用文本编辑器打开，有以下几个参数需要修改：
账户密码类配置项：
1. PHOTOPRISM_ADMIN_USER：网页端管理员登录的用户名，默认是admin，建议修改 2. PHOTOPRISM_ADMIN_PASSWORD：网页端管理员登录的密码，建议修改 3. PHOTOPRISM_DATABASE_PASSWORD：数据库的密码，建议修改 4. MARIADB_PASSWORD：服务默认用的数据库是mariadb，这里配置photoprism数据库的密码。注意这个密码要和上一条中的PHOTOPRISM_DATABASE_PASSWORD的密码保持一致 5. MARIADB_ROOT_PASSWORD：数据库的root账户密码，建议修改 文件路径类配置项：
1. &amp;#34;~/Pictures:/photoprism/originals&amp;#34;：这项指定原图的归档目录，建议指向一个大容量hdd，一个硬盘专门用来放原图，方便后期维护。 2. &amp;#34;~/Import:/photoprism/import&amp;#34; ：这项指定需要导入的目录，默认是注释的（不启用），可选，有图库需要批量导入的可以这里指定路径，然后系统会把图片转移到originals目录进行归档。 3.</description>
    </item>
    
  </channel>
</rss>
